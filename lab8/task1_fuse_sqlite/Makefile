CC = gcc
CFLAGS = -Wall -Wextra -D_FILE_OFFSET_BITS=64
CFLAGS_COV = $(CFLAGS) -fprofile-arcs -ftest-coverage -O0
LDFLAGS = `pkg-config fuse --cflags --libs` -lsqlite3
LDFLAGS_COV = $(LDFLAGS) -lgcov --coverage

TARGET = fuse_sqlite_fs
TARGET_COV = fuse_sqlite_fs_cov
SRC = fuse_sqlite_fs.c

all: $(TARGET)

$(TARGET): $(SRC)
	$(CC) $(CFLAGS) -o $(TARGET) $(SRC) $(LDFLAGS)

$(TARGET_COV): $(SRC)
	$(CC) $(CFLAGS_COV) -o $(TARGET_COV) $(SRC) $(LDFLAGS_COV)

clean:
	@pkill -9 fuse_sqlite_fs 2>/dev/null || true
	@fusermount -u mountpoint 2>/dev/null || fusermount3 -u mountpoint 2>/dev/null || true
	@sleep 1
	@rm -f $(TARGET) $(TARGET_COV) filesystem.db fuse.log
	@rm -rf mountpoint
	@rm -f *.gcda *.gcno *.gcov coverage.info
	@rm -rf coverage_html
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

coverage: $(TARGET_COV)
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "  –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏–∑–º–µ—Ä–µ–Ω–∏–µ–º –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@pkill -9 fuse_sqlite_fs 2>/dev/null || true
	@fusermount -u mountpoint 2>/dev/null || true
	@sleep 1
	@rm -rf mountpoint filesystem.db fuse.log *.gcda
	@echo "‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
	@echo ""
	@chmod +x tests.sh
	@FUSE_BIN="$(shell pwd)/$(TARGET_COV)" bash tests.sh
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "  –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@gcov $(TARGET_COV)-fuse_sqlite_fs.gcda 2>&1 | grep -E "File|Lines|Creating"
	@echo ""
	@echo "üìä –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ fuse_sqlite_fs.c.gcov"
	@echo ""
	@if [ -f fuse_sqlite_fs.c.gcov ]; then \
		echo "‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞:"; \
		echo ""; \
		gcov $(TARGET_COV)-fuse_sqlite_fs.gcda 2>&1 | grep "Lines executed" | head -1; \
		echo ""; \
		echo "üí° –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç: less fuse_sqlite_fs.c.gcov"; \
	else \
		echo "‚ö†Ô∏è  –§–∞–π–ª gcov –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
	fi
	@echo ""

mount: $(TARGET)
	mkdir -p mountpoint
	./$(TARGET) mountpoint -f

umount:
	fusermount -u mountpoint 2>/dev/null || fusermount3 -u mountpoint 2>/dev/null || true
	rmdir mountpoint 2>/dev/null || true

test: $(TARGET)
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "  –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@pkill -9 fuse_sqlite_fs 2>/dev/null || true
	@fusermount -u mountpoint 2>/dev/null || true
	@sleep 1
	@rm -rf mountpoint filesystem.db
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
	@echo ""
	@chmod +x tests.sh
	@bash tests.sh

mount_bg: $(TARGET)
	@mkdir -p mountpoint
	@echo "–ó–∞–ø—É—Å–∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ —Ñ–æ–Ω–µ..."
	@bash -c "cd $(shell pwd) && ./$(TARGET) mountpoint" &
	@sleep 2
	@echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
	@mount | grep fuse_sqlite || echo "–û—à–∏–±–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!"

run: $(TARGET)
	@mkdir -p mountpoint
	@echo "–ó–∞–ø—É—Å–∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã (Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)..."
	./$(TARGET) mountpoint -f

.PHONY: all clean mount umount test mount_bg run coverage
